name: Playwright Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  e2e:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # WebKit auf Linux CI ist instabil (Timeout-Probleme)
        browser: [chromium, firefox]
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2
        with:
          php-version: '8.5'
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'
      - run: composer install --no-interaction --prefer-dist
      - run: cp .env.example .env
      - run: php artisan key:generate
      - name: Configure SQLite
        run: |
          sed -i 's/^DB_CONNECTION=.*/DB_CONNECTION=sqlite/' .env
          sed -i 's/^DB_DATABASE=.*/DB_DATABASE=database\/database.sqlite/' .env
          touch database/database.sqlite
      - run: php artisan migrate --force
      - run: npm ci
      - run: npm run build --if-present
      - name: Debug - Verify build integrity
        run: |
          echo "=== Build manifest ==="
          cat public/build/manifest.json || echo "No manifest found"
          echo ""
          echo "=== All built assets ==="
          ls -laR public/build/ || echo "No build directory"
          echo ""
          echo "=== Check for hot file ==="
          ls -la public/hot 2>&1 || echo "No hot file (expected in production build)"
          echo ""
          echo "=== Verify all manifest files exist ==="
          php -r '
            $manifest = json_decode(file_get_contents("public/build/manifest.json"), true);
            $missing = [];
            foreach ($manifest as $key => $entry) {
              $file = "public/build/" . $entry["file"];
              if (!file_exists($file)) {
                $missing[] = $file;
              }
            }
            if (count($missing) > 0) {
              echo "MISSING FILES:\n";
              foreach ($missing as $f) echo "  - $f\n";
              exit(1);
            }
            echo "All " . count($manifest) . " manifest entries verified!\n";
          '
      - name: Clear Laravel caches
        run: |
          php artisan config:clear
          php artisan view:clear
          php artisan route:clear
          php artisan cache:clear || true
      - name: Test server.php asset serving
        run: |
          # Start server in background
          php -S 127.0.0.1:8888 server.php &
          SERVER_PID=$!
          sleep 2
          
          # Get a CSS file from manifest
          CSS_FILE=$(php -r 'echo json_decode(file_get_contents("public/build/manifest.json"), true)["resources/css/app.css"]["file"];')
          echo "Testing asset: /build/$CSS_FILE"
          
          # Test if we can fetch it
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:8888/build/$CSS_FILE")
          echo "HTTP response code: $HTTP_CODE"
          
          # Also test the homepage
          echo "Testing homepage..."
          curl -s "http://127.0.0.1:8888/" | head -100
          
          kill $SERVER_PID 2>/dev/null || true
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Asset serving failed!"
            exit 1
          fi
          echo "Asset serving test passed!"
      - run: npx playwright install-deps ${{ matrix.browser }}
      - run: npx playwright install ${{ matrix.browser }}
      - run: npx playwright test --project=${{ matrix.browser }}
